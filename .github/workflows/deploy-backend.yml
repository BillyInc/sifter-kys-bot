name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'Backend/**'
      - '.github/workflows/deploy-backend.yml'
  pull_request:
    branches: [main]
    paths:
      - 'Backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: true

env:
  DEPLOY_PATH: ~/sifter-backend
  PYTHON_VERSION: '3.11'

jobs:
  # ==================
  # Lint & Test
  # ==================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: Backend/requirements.txt

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: |
          uv pip install --system -r requirements.txt
          uv pip install --system flake8 pyright

      - name: Run flake8
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run pyright
        run: pyright --warnings
        continue-on-error: true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    defaults:
      run:
        working-directory: Backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: Backend/requirements.txt

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: |
          uv pip install --system -r requirements.txt
          uv pip install --system pytest pytest-cov

      - name: Run tests
        run: pytest --tb=short -q || echo "No tests found or tests skipped"
        continue-on-error: true

  # ==================
  # Deploy
  # ==================
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "::error::SERVER_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "::error::SERVER_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "::error::SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > Backend/.env
          chmod 600 Backend/.env

      - name: Deploy with rsync
        run: |
          rsync -avz --delete \
            --exclude '.venv' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude 'logs/' \
            --exclude '*.db' \
            --exclude '.git' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            Backend/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Install dependencies and restart
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}

            # Secure .env file permissions
            chmod 600 .env

            # Create venv if not exists
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi

            # Install/update dependencies
            source .venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # Create logs directory
            mkdir -p logs

            # Install/update systemd service files
            sudo cp systemd/*.service /etc/systemd/system/
            sudo systemctl daemon-reload

            # Enable services on first deploy
            sudo systemctl enable sifter-backend rq-worker@{1..5} wallet-monitor 2>/dev/null || true

            # Restart services (graceful reload for gunicorn)
            sudo systemctl reload-or-restart sifter-backend
            sudo systemctl restart rq-worker@{1..5}
            sudo systemctl restart wallet-monitor

            echo "Deployment complete!"
          ENDSSH

      - name: Health check
        continue-on-error: true
        run: |
          sleep 10
          curl -f --max-time 30 http://${{ secrets.SERVER_HOST }}:5000/health && echo "Health check passed!" || echo "::warning::Health check failed - server may need manual verification"

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f Backend/.env
